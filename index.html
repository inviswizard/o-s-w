<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Space</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #f8d7da;
            --secondary-lavender: #e7d3f4;
            --soft-peach: #ffeaa7;
            --mint-green: #d1f2eb;
            --soft-blue: #d4f1f4;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --error: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--primary-pink), var(--soft-blue));
            min-height: 100vh;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--text-light);
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--white);
            border-radius: 25px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 600px;
            width: 100%;
        }

        .auth-card h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary-pink), var(--secondary-lavender));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 1rem;
        }

        .auth-tab.active {
            background: var(--primary-pink);
            color: var(--text-dark);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .password-toggle {
            position: relative;
        }

        .password-toggle button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--primary-pink);
            object-fit: cover;
            background: var(--mint-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-button {
            background: var(--secondary-lavender);
            color: var(--text-dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            background: var(--primary-pink);
        }

        .divider {
            margin: 1.5rem 0;
            text-align: center;
            color: var(--text-light);
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: white;
            padding: 0 1rem;
        }

        /* Room Management */
        .room-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .room-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-room-btn {
            background: var(--secondary-lavender);
            color: var(--text-dark);
        }

        .join-room-btn {
            background: var(--primary-pink);
            color: var(--text-dark);
        }

        .room-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .room-input-container {
            margin-top: 2rem;
            display: none;
        }

        .room-input-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .room-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--text-light);
            border-radius: 15px;
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .room-input:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .room-code-display {
            background: var(--mint-green);
            padding: 1rem;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 3px;
            margin-bottom: 1rem;
        }

        .join-request-status {
            background: var(--warning);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        .alert.error {
            background: #ffeaea;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert.success {
            background: #eafaf1;
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert.warning {
            background: #fff3cd;
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .btn {
            background: var(--secondary-lavender);
            color: var(--text-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }

        .btn.primary {
            background: var(--primary-pink);
        }

        .btn.primary:hover {
            background: var(--secondary-lavender);
        }

        .btn.danger {
            background: var(--error);
            color: white;
        }

        .btn.danger:hover {
            background: #c0392b;
        }

        .auth-link {
            margin-top: 1rem;
            color: var(--text-light);
        }

        .auth-link a {
            color: var(--primary-pink);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-link a:hover {
            color: var(--secondary-lavender);
        }

        /* Navigation and other styles */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px var(--shadow);
            display: none;
        }

        nav.active {
            display: block;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu li {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu li:hover, .nav-menu li.active {
            background: var(--secondary-lavender);
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .notification-badge {
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 2rem 2rem;
            min-height: 100vh;
            display: none;
        }

        .container.active {
            display: block;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            margin-bottom: 1rem;
            color: var(--text-dark);
            font-size: 1.8rem;
        }

        /* Memories styles */
        .upload-area {
            border: 2px dashed var(--primary-pink);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(248, 215, 218, 0.2);
        }

        .memories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .memory-item {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            height: 200px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .memory-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .memory-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .memory-item:hover .memory-actions {
            opacity: 1;
        }

        .memory-actions button {
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Members styles */
        .members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .member-card {
            background: var(--white);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary-pink);
        }

        .nickname-form {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .nickname-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }

        /* Notes styles */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .note-card {
            background: var(--soft-peach);
            border-radius: 15px;
            padding: 1.5rem;
            position: relative;
            min-height: 200px;
        }

        .note-actions {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .add-note-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-pink);
            color: var(--text-dark);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 15px var(--shadow);
            z-index: 100;
        }

        /* Settings styles */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-card {
                padding: 2rem;
            }

            .room-options {
                flex-direction: column;
                align-items: center;
            }

            .nav-menu {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 120px 1rem 1rem;
            }

            .memories-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>Our Space 💕</h1>
            <p>A private sanctuary for couples to connect, share memories, and stay close no matter the distance.</p>
            
            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showTab('login')">Login</button>
                <button class="auth-tab" onclick="showTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email address" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <div class="password-toggle">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        <button type="button" onclick="togglePassword('loginPassword')">👁️</button>
                    </div>
                </div>
                
                <button class="btn primary" onclick="loginUser()">Login</button>
                
                <div class="auth-link">
                    Don't have an account? <a href="#" onclick="showTab('register')">Register here</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email address" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <div class="password-toggle">
                        <input type="password" id="registerPassword" placeholder="Create a strong password" required>
                        <button type="button" onclick="togglePassword('registerPassword')">👁️</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <div class="password-toggle">
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                        <button type="button" onclick="togglePassword('confirmPassword')">👁️</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="How should we call you?" required>
                </div>
                
                <div class="form-group">
                    <label>Profile Picture</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="avatarPreview">👤</div>
                        <div class="file-input-wrapper">
                            <input type="file" id="avatarInput" class="file-input" accept="image/*">
                            <button type="button" class="file-input-button" onclick="document.getElementById('avatarInput').click()">
                                Upload Photo
                            </button>
                        </div>
                    </div>
                </div>
                
                <button class="btn primary" onclick="registerUser()">Create Account</button>
                
                <div class="auth-link">
                    Already have an account? <a href="#" onclick="showTab('login')">Login here</a>
                </div>
            </div>

            <!-- Room Management (shown after login) -->
            <div id="roomManagement" style="display: none;">
                <div class="room-options">
                    <button class="room-btn create-room-btn" onclick="showCreateRoom()" id="createRoomBtn">Create Room</button>
                    <button class="room-btn join-room-btn" onclick="showJoinRoom()" id="joinRoomBtn">Join Room</button>
                </div>

                <div id="createRoomContainer" class="room-input-container">
                    <p>Your room code:</p>
                    <div id="roomCodeDisplay" class="room-code-display"></div>
                    <p style="font-size: 0.9rem; color: var(--text-light);">Share this code with your partner</p>
                    <button class="btn primary" onclick="createRoom()">Create Our Space</button>
                </div>

                <div id="joinRoomContainer" class="room-input-container">
                    <input type="text" id="roomCodeInput" class="room-input" placeholder="Enter Room Code" maxlength="8">
                    <button class="btn primary" onclick="requestToJoin()" id="joinSubmitBtn">Request to Join</button>
                    
                    <div id="joinRequestStatus" class="join-request-status" style="display: none;">
                        <p>Join request sent! Waiting for approval from room admin...</p>
                        <button class="btn small" onclick="cancelJoinRequest()">Cancel Request</button>
                    </div>
                </div>

                <div id="alertContainer"></div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav id="mainNav">
        <div class="nav-content">
            <ul class="nav-menu">
                <li class="nav-item active" data-page="home">🏠 Home</li>
                <li class="nav-item" data-page="memories">📸 Memories</li>
                <li class="nav-item" data-page="notes">📝 Notes</li>
                <li class="nav-item" data-page="links">🔗 Links</li>
                <li class="nav-item" data-page="members">👥 Members</li>
                <li class="nav-item" data-page="settings">⚙️ Settings</li>
                <li class="nav-item" data-page="chat">💬 Chat</li>
            </ul>
            <div class="user-info">
                <div style="position: relative;">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <span id="userNameNav"></span>
                <button class="btn danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="mainContainer" class="container">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="card">
                <h2>Welcome to Our Space 💕</h2>
                <p id="welcomeMessage">Start creating beautiful memories together!</p>
                <div id="homeContent">
                    <p>This is your private space to share memories, notes, and stay connected with your partner.</p>
                    <h3>How it works:</h3>
                    <ul>
                        <li>Create or join a room with your partner</li>
                        <li>Share photos and memories in the Memories tab</li>
                        <li>Leave sweet notes for each other</li>
                        <li>Save important links you want to share</li>
                        <li>Chat privately in real-time</li>
                    </ul>
                    <p>All your data is securely stored in a GitHub repository for privacy and control.</p>
                </div>
            </div>
        </div>

        <!-- Memories Page -->
        <div id="memories" class="page">
            <div class="card">
                <h2>Our Memories 📸</h2>
                <p>Capture and share your special moments</p>
                
                <div class="upload-area" onclick="document.getElementById('memoryUpload').click()">
                    <input type="file" id="memoryUpload" accept="image/*" multiple style="display: none;" onchange="handleMemoryUpload(event)">
                    <p>Click here or drag and drop to upload images</p>
                    <small>Supported formats: JPG, PNG, GIF</small>
                </div>
                
                <div id="memoriesGrid" class="memories-grid">
                    <!-- Memories will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Notes Page -->
        <div id="notes" class="page">
            <div class="card">
                <h2>Sweet Notes 📝</h2>
                <p>Leave loving messages for each other</p>
                
                <div id="notesContainer" class="notes-container">
                    <!-- Notes will be loaded here -->
                </div>
                
                <button class="add-note-btn" onclick="showAddNoteModal()">+</button>
            </div>
        </div>

        <!-- Links Page -->
        <div id="links" class="page">
            <div class="card">
                <h2>Important Links 🔗</h2>
                <p>Save websites and resources that matter to you</p>
                <!-- Links content will go here -->
            </div>
        </div>

        <!-- Members Page -->
        <div id="members" class="page">
            <div class="card">
                <h2>Room Members 👥</h2>
                <p>Manage who has access to your space</p>
                
                <div id="pendingRequests" style="display: none;">
                    <h3>Pending Join Requests</h3>
                    <div id="requestsList"></div>
                </div>
                
                <div id="membersList" class="members-list">
                    <!-- Members will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="card">
                <h2>Settings ⚙️</h2>
                
                <div class="settings-section">
                    <h3>GitHub Storage</h3>
                    <p>Your data is stored in a private GitHub repository for maximum control and privacy.</p>
                    
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" placeholder="Enter your GitHub token">
                    </div>
                    
                    <div class="form-group">
                        <label for="githubRepo">GitHub Repository (username/repo)</label>
                        <input type="text" id="githubRepo" placeholder="Enter your repository name">
                    </div>
                    
                    <button class="btn primary" onclick="saveGitHubSettings()">Save Settings</button>
                    <button class="btn" onclick="useDefaultStorage()">Use Default Storage</button>
                </div>
                
                <div class="settings-section">
                    <h3>Advanced Privacy</h3>
                    <p>Want to use your own storage? Connect your own GitHub repository.</p>
                    <button class="btn" onclick="migrateToCustomRepo()">Migrate to Custom Repository</button>
                </div>
                
                <div class="settings-section">
                    <h3>Danger Zone</h3>
                    <button class="btn danger" onclick="deleteAccount()">Delete Account</button>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chat" class="page">
            <div class="card">
                <h2>Private Chat 💬</h2>
                <p>Your private conversation space</p>
                <!-- Chat interface will go here -->
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px;">
            <h3>Add New Note</h3>
            <div class="form-group">
                <textarea id="noteContent" placeholder="Write your note here..." rows="5"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn primary" onclick="saveNote()">Save</button>
                <button class="btn" onclick="document.getElementById('addNoteModal').style.display = 'none'">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRoom = null;
        let githubToken = null;
        let githubRepo = null;
        const DEFAULT_REPO = "ourspace/default-data";

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingSession();
            setupEventListeners();
            loadGitHubSettings();
        });

        function setupEventListeners() {
            // Avatar upload
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });

            // Drag and drop for memories
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(248, 215, 218, 0.5)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    handleMemoryUpload({ target: { files: e.dataTransfer.files } });
                }
            });
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(tabName + 'Form').classList.add('active');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('avatarPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function registerUser() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const displayName = document.getElementById('displayName').value.trim();
            
            // Validation
            if (!email || !password || !confirmPassword || !displayName) {
                showAlert('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long');
                return;
            }
            
            showLoading();
            
            try {
                // Check if user already exists
                const existingUsers = await githubReadFile('users.json');
                if (existingUsers.find(user => user.email === email)) {
                    throw new Error('An account with this email already exists');
                }
                
                // Get avatar data
                const avatarInput = document.getElementById('avatarInput');
                let avatarData = null;
                if (avatarInput.files[0]) {
                    avatarData = await fileToBase64(avatarInput.files[0]);
                }
                
                // Create new user
                const newUser = {
                    id: generateUserId(),
                    email: email,
                    password: await hashPassword(password),
                    displayName: displayName,
                    avatar: avatarData,
                    createdAt: new Date().toISOString(),
                    rooms: []
                };
                
                // Save user
                existingUsers.push(newUser);
                await githubWriteFile('users.json', existingUsers);
                
                // Login the user
                currentUser = newUser;
                localStorage.setItem('ourspace_current_user', JSON.stringify(newUser));
                
                showAlert('Account created successfully!', 'success');
                showRoomManagement();
                
            } catch (error) {
                showAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password');
                return;
            }
            
            showLoading();
            
            try {
                const existingUsers = await githubReadFile('users.json');
                const user = existingUsers.find(u => u.email === email);
                
                if (!user) {
                    throw new Error('No account found with this email address');
                }
                
                const passwordHash = await hashPassword(password);
                if (user.password !== passwordHash) {
                    throw new Error('Invalid password');
                }
                
                // Login successful
                currentUser = user;
                localStorage.setItem('ourspace_current_user', JSON.stringify(user));
                
                showAlert('Login successful!', 'success');
                showRoomManagement();
                
            } catch (error) {
                showAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        function checkExistingSession() {
            const savedUser = localStorage.getItem('ourspace_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showRoomManagement();
            }
        }

        function showRoomManagement() {
            document.querySelectorAll('.auth-form').forEach(form => {
                form.style.display = 'none';
            });
            document.querySelector('.auth-tabs').style.display = 'none';
            document.getElementById('roomManagement').style.display = 'block';
        }

        function showCreateRoom() {
            document.getElementById('createRoomContainer').classList.add('active');
            document.getElementById('joinRoomContainer').classList.remove('active');
            
            // Generate room code
            const roomCode = generateRoomCode();
            document.getElementById('roomCodeDisplay').textContent = roomCode;
        }

        function showJoinRoom() {
            document.getElementById('joinRoomContainer').classList.add('active');
            document.getElementById('createRoomContainer').classList.remove('active');
        }

        async function createRoom() {
            const roomCode = document.getElementById('roomCodeDisplay').textContent;
            
            showLoading();
            
            try {
                // Check if room code already exists
                const allRooms = await getAllRooms();
                if (allRooms.find(room => room.code === roomCode)) {
                    // Regenerate code if exists (extremely rare but possible)
                    document.getElementById('roomCodeDisplay').textContent = generateRoomCode();
                    throw new Error('Room code already exists. Try again.');
                }
                
                const newRoom = {
                    id: generateRoomId(),
                    code: roomCode,
                    adminId: currentUser.id,
                    adminEmail: currentUser.email,
                    members: [{
                        userId: currentUser.id,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        avatar: currentUser.avatar,
                        role: 'admin',
                        joinedAt: new Date().toISOString()
                    }],
                    createdAt: new Date().toISOString(),
                    joinRequests: [],
                    memories: [],
                    notes: [],
                    links: [],
                    nicknames: {}
                };
                
                // Save room
                await saveRoom(newRoom);
                
                // Update user's rooms
                currentUser.rooms.push(newRoom.id);
                await updateUser(currentUser);
                
                localStorage.setItem('ourspace_current_user', JSON.stringify(currentUser));
                
                currentRoom = newRoom;
                localStorage.setItem('ourspace_current_room', JSON.stringify(newRoom));
                
                showAlert('Room created successfully!', 'success');
                enterRoom();
                
            } catch (error) {
                showAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        async function requestToJoin() {
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!roomCode) {
                showAlert('Please enter a room code');
                return;
            }
            
            // Check if user is already in a room
            if (currentUser.rooms && currentUser.rooms.length > 0) {
                showAlert('You are already in a room. Please leave your current room before joining a new one.');
                return;
            }
            
            showLoading();
            
            try {
                const allRooms = await getAllRooms();
                const room = allRooms.find(r => r.code === roomCode);
                
                if (!room) {
                    throw new Error('Room not found. Please check the room code.');
                }
                
                // Check if user is already a member
                if (room.members.find(m => m.userId === currentUser.id)) {
                    throw new Error('You are already a member of this room');
                }
                
                // Check if there's already a pending request
                if (room.joinRequests.find(r => r.userId === currentUser.id)) {
                    throw new Error('You already have a pending join request for this room');
                }
                
                // Add join request
                room.joinRequests.push({
                    userId: currentUser.id,
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    avatar: currentUser.avatar,
                    requestedAt: new Date().toISOString()
                });
                
                // Save updated room
                await saveRoom(room);
                
                document.getElementById('joinRequestStatus').style.display = 'block';
                document.getElementById('joinSubmitBtn').disabled = true;
                
                showAlert('Join request sent! Waiting for admin approval.', 'success');
                
            } catch (error) {
                showAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        function enterRoom() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainNav').classList.add('active');
            document.getElementById('mainContainer').classList.add('active');
            
            // Update nav user info
            document.getElementById('userNameNav').textContent = currentUser.displayName;
            if (currentUser.avatar) {
                document.getElementById('userAvatar').src = currentUser.avatar;
            }
            
            // Load room data
            loadRoomData();
        }

        function navigateTo(page) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            // Show corresponding page
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(page).classList.add('active');
            
            // Load specific page data
            if (page === 'memories') {
                loadMemories();
            } else if (page === 'members') {
                loadMembers();
            } else if (page === 'notes') {
                loadNotes();
            }
        }

        function logout() {
            localStorage.removeItem('ourspace_current_user');
            localStorage.removeItem('ourspace_current_room');
            currentUser = null;
            currentRoom = null;
            
            // Reset UI
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('mainNav').classList.remove('active');
            document.getElementById('mainContainer').classList.remove('active');
            
            // Reset forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.style.display = 'none';
            });
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('roomManagement').style.display = 'none';
            
            showAlert('Logged out successfully', 'success');
        }

        // GitHub Storage Functions
        async function githubReadFile(path) {
            try {
                // If using default repo and no token is set, use the one from AppWrite secrets
                const repo = githubRepo || DEFAULT_REPO;
                const token = githubToken || await getSecretToken();
                
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // File doesn't exist yet, return empty array or default value
                        return path === 'users.json' ? [] : null;
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (error) {
                console.error('Error reading from GitHub:', error);
                // Fallback to empty data
                return path === 'users.json' ? [] : null;
            }
        }

        async function githubWriteFile(path, content) {
            try {
                const repo = githubRepo || DEFAULT_REPO;
                const token = githubToken || await getSecretToken();
                
                // Check if file exists to get its SHA
                let sha = null;
                try {
                    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's fine
                }
                
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${path}`,
                        content: btoa(JSON.stringify(content)),
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                return true;
            } catch (error) {
                console.error('Error writing to GitHub:', error);
                showAlert('Error saving data. Please check your GitHub settings.');
                return false;
            }
        }

        async function getAllRooms() {
            // Check master file to see which room files exist
            try {
                const master = await githubReadFile('rooms_master.json') || { files: ['rooms_data_1.json'] };
                let allRooms = [];
                
                for (const file of master.files) {
                    const rooms = await githubReadFile(file) || [];
                    allRooms = allRooms.concat(rooms);
                }
                
                return allRooms;
            } catch (error) {
                console.error('Error reading rooms:', error);
                return [];
            }
        }

        async function saveRoom(room) {
            try {
                // Get master file
                const master = await githubReadFile('rooms_master.json') || { files: ['rooms_data_1.json'] };
                
                // Find which file contains this room or where to put it
                let targetFile = master.files[master.files.length - 1]; // Start with the last file
                
                // Check if room already exists in any file
                for (const file of master.files) {
                    const rooms = await githubReadFile(file) || [];
                    const roomIndex = rooms.findIndex(r => r.id === room.id);
                    
                    if (roomIndex !== -1) {
                        // Update existing room
                        rooms[roomIndex] = room;
                        await githubWriteFile(file, rooms);
                        return true;
                    }
                }
                
                // Room is new, add to the last file
                const rooms = await githubReadFile(targetFile) || [];
                rooms.push(room);
                
                // Check if file size would exceed ~100MB (approximate)
                const jsonSize = JSON.stringify(rooms).length;
                if (jsonSize > 100000000) { // ~100MB
                    // Create new file
                    const newFileIndex = master.files.length + 1;
                    targetFile = `rooms_data_${newFileIndex}.json`;
                    master.files.push(targetFile);
                    
                    // Save master file
                    await githubWriteFile('rooms_master.json', master);
                    
                    // Create new file with just this room
                    await githubWriteFile(targetFile, [room]);
                } else {
                    // Save updated rooms to existing file
                    await githubWriteFile(targetFile, rooms);
                }
                
                return true;
            } catch (error) {
                console.error('Error saving room:', error);
                return false;
            }
        }

        async function updateUser(user) {
            const users = await githubReadFile('users.json') || [];
            const userIndex = users.findIndex(u => u.id === user.id);
            
            if (userIndex !== -1) {
                users[userIndex] = user;
                await githubWriteFile('users.json', users);
                return true;
            }
            
            return false;
        }

        // Room Data Management
        async function loadRoomData() {
            if (!currentRoom) return;
            
            // Check for updates to the room
            const allRooms = await getAllRooms();
            const updatedRoom = allRooms.find(r => r.id === currentRoom.id);
            
            if (updatedRoom) {
                currentRoom = updatedRoom;
                localStorage.setItem('ourspace_current_room', JSON.stringify(updatedRoom));
                
                // Update notification badge if there are pending requests (for admin)
                if (currentUser.id === currentRoom.adminId && currentRoom.joinRequests.length > 0) {
                    document.getElementById('notificationBadge').style.display = 'flex';
                    document.getElementById('notificationBadge').textContent = currentRoom.joinRequests.length;
                }
            }
        }

        async function loadMemories() {
            if (!currentRoom || !currentRoom.memories) return;
            
            const memoriesGrid = document.getElementById('memoriesGrid');
            memoriesGrid.innerHTML = '';
            
            currentRoom.memories.forEach(memory => {
                const memoryElement = document.createElement('div');
                memoryElement.className = 'memory-item';
                memoryElement.innerHTML = `
                    <img src="${memory.imageData}" alt="Memory">
                    <div class="memory-actions">
                        <button onclick="deleteMemory('${memory.id}')">🗑️</button>
                    </div>
                `;
                memoriesGrid.appendChild(memoryElement);
            });
        }

        async function handleMemoryUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            showLoading();
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const imageData = await fileToBase64(file);
                    
                    const newMemory = {
                        id: generateId(),
                        imageData: imageData,
                        uploadedBy: currentUser.id,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    currentRoom.memories.push(newMemory);
                }
                
                // Save updated room
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                // Reload memories
                loadMemories();
                showAlert('Memories uploaded successfully!', 'success');
                
            } catch (error) {
                showAlert('Error uploading memories: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteMemory(memoryId) {
            if (!confirm('Are you sure you want to delete this memory?')) return;
            
            showLoading();
            
            try {
                currentRoom.memories = currentRoom.memories.filter(m => m.id !== memoryId);
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                loadMemories();
                showAlert('Memory deleted successfully', 'success');
            } catch (error) {
                showAlert('Error deleting memory: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadMembers() {
            if (!currentRoom) return;
            
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            // Show pending requests for admin
            if (currentUser.id === currentRoom.adminId && currentRoom.joinRequests.length > 0) {
                document.getElementById('pendingRequests').style.display = 'block';
                const requestsList = document.getElementById('requestsList');
                requestsList.innerHTML = '';
                
                currentRoom.joinRequests.forEach(request => {
                    const requestElement = document.createElement('div');
                    requestElement.className = 'member-card';
                    requestElement.innerHTML = `
                        <img src="${request.avatar || '👤'}" class="member-avatar" alt="${request.displayName}">
                        <h3>${request.displayName}</h3>
                        <p>${request.email}</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn primary" onclick="approveJoinRequest('${request.userId}')">Approve</button>
                            <button class="btn danger" onclick="rejectJoinRequest('${request.userId}')">Reject</button>
                        </div>
                    `;
                    requestsList.appendChild(requestElement);
                });
            } else {
                document.getElementById('pendingRequests').style.display = 'none';
            }
            
            // Display members
            currentRoom.members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-card';
                
                // Get nickname if exists
                const nickname = currentRoom.nicknames && currentRoom.nicknames[member.userId] 
                    ? currentRoom.nicknames[member.userId] 
                    : member.displayName;
                
                memberElement.innerHTML = `
                    <img src="${member.avatar || '👤'}" class="member-avatar" alt="${member.displayName}">
                    <h3>${nickname}</h3>
                    <p>${member.role === 'admin' ? 'Admin' : 'Member'}</p>
                    ${member.userId !== currentUser.id ? `
                        <div class="nickname-form">
                            <input type="text" class="nickname-input" id="nickname-${member.userId}" placeholder="Set nickname">
                            <button class="btn" onclick="setNickname('${member.userId}')">Save</button>
                        </div>
                    ` : ''}
                    ${currentUser.id === currentRoom.adminId && member.userId !== currentUser.id ? `
                        <button class="btn danger" onclick="removeMember('${member.userId}')" style="margin-top: 1rem;">Remove</button>
                    ` : ''}
                `;
                
                membersList.appendChild(memberElement);
            });
        }

        async function approveJoinRequest(userId) {
            showLoading();
            
            try {
                const request = currentRoom.joinRequests.find(r => r.userId === userId);
                if (!request) {
                    throw new Error('Join request not found');
                }
                
                // Add user to members
                currentRoom.members.push({
                    userId: request.userId,
                    email: request.email,
                    displayName: request.displayName,
                    avatar: request.avatar,
                    role: 'member',
                    joinedAt: new Date().toISOString()
                });
                
                // Remove from join requests
                currentRoom.joinRequests = currentRoom.joinRequests.filter(r => r.userId !== userId);
                
                // Update user's room list
                const users = await githubReadFile('users.json');
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].rooms.push(currentRoom.id);
                    await githubWriteFile('users.json', users);
                }
                
                // Save room
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                // Update UI
                loadMembers();
                document.getElementById('notificationBadge').textContent = currentRoom.joinRequests.length;
                if (currentRoom.joinRequests.length === 0) {
                    document.getElementById('notificationBadge').style.display = 'none';
                }
                
                showAlert('Join request approved', 'success');
                
            } catch (error) {
                showAlert('Error approving request: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function rejectJoinRequest(userId) {
            showLoading();
            
            try {
                // Remove from join requests
                currentRoom.joinRequests = currentRoom.joinRequests.filter(r => r.userId !== userId);
                
                // Save room
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                // Update UI
                loadMembers();
                document.getElementById('notificationBadge').textContent = currentRoom.joinRequests.length;
                if (currentRoom.joinRequests.length === 0) {
                    document.getElementById('notificationBadge').style.display = 'none';
                }
                
                showAlert('Join request rejected', 'success');
                
            } catch (error) {
                showAlert('Error rejecting request: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function setNickname(userId) {
            const nicknameInput = document.getElementById(`nickname-${userId}`);
            const nickname = nicknameInput.value.trim();
            
            if (!nickname) {
                showAlert('Please enter a nickname');
                return;
            }
            
            showLoading();
            
            try {
                if (!currentRoom.nicknames) {
                    currentRoom.nicknames = {};
                }
                
                currentRoom.nicknames[userId] = nickname;
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                loadMembers();
                showAlert('Nickname set successfully', 'success');
                
            } catch (error) {
                showAlert('Error setting nickname: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function removeMember(userId) {
            if (!confirm('Are you sure you want to remove this member?')) return;
            
            showLoading();
            
            try {
                // Remove from members
                currentRoom.members = currentRoom.members.filter(m => m.userId !== userId);
                
                // Update user's room list
                const users = await githubReadFile('users.json');
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].rooms = users[userIndex].rooms.filter(r => r !== currentRoom.id);
                    await githubWriteFile('users.json', users);
                }
                
                // If admin is removing themselves, transfer admin rights
                if (userId === currentUser.id) {
                    if (currentRoom.members.length > 0) {
                        // Transfer admin to the next member (by join time)
                        const newAdmin = currentRoom.members.reduce((oldest, member) => {
                            return new Date(member.joinedAt) < new Date(oldest.joinedAt) ? member : oldest;
                        });
                        
                        newAdmin.role = 'admin';
                        currentRoom.adminId = newAdmin.userId;
                        currentRoom.adminEmail = newAdmin.email;
                        
                        // Update current user
                        currentUser.rooms = currentUser.rooms.filter(r => r !== currentRoom.id);
                        await updateUser(currentUser);
                        localStorage.setItem('ourspace_current_user', JSON.stringify(currentUser));
                        
                        // Leave the room
                        currentRoom = null;
                        localStorage.removeItem('ourspace_current_room');
                        
                        // Return to auth screen
                        logout();
                        showAlert('You have left the room. Admin rights transferred to another member.', 'success');
                        return;
                    } else {
                        // No members left, delete the room
                        await deleteRoom(currentRoom.id);
                        currentRoom = null;
                        localStorage.removeItem('ourspace_current_room');
                        
                        // Update current user
                        currentUser.rooms = currentUser.rooms.filter(r => r !== currentRoom.id);
                        await updateUser(currentUser);
                        localStorage.setItem('ourspace_current_user', JSON.stringify(currentUser));
                        
                        // Return to auth screen
                        logout();
                        showAlert('Room deleted as there are no members left.', 'info');
                        return;
                    }
                }
                
                // Save room
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                // Update UI
                loadMembers();
                showAlert('Member removed successfully', 'success');
                
            } catch (error) {
                showAlert('Error removing member: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadNotes() {
            if (!currentRoom || !currentRoom.notes) return;
            
            const notesContainer = document.getElementById('notesContainer');
            notesContainer.innerHTML = '';
            
            currentRoom.notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-card';
                noteElement.innerHTML = `
                    <p>${note.content}</p>
                    <small>By ${note.authorName} on ${new Date(note.createdAt).toLocaleDateString()}</small>
                    ${note.authorId === currentUser.id ? `
                        <div class="note-actions">
                            <button onclick="editNote('${note.id}')">✏️</button>
                            <button onclick="deleteNote('${note.id}')">🗑️</button>
                        </div>
                    ` : ''}
                `;
                notesContainer.appendChild(noteElement);
            });
        }

        function showAddNoteModal() {
            document.getElementById('addNoteModal').style.display = 'flex';
            document.getElementById('noteContent').value = '';
        }

        async function saveNote() {
            const content = document.getElementById('noteContent').value.trim();
            
            if (!content) {
                showAlert('Please enter note content');
                return;
            }
            
            showLoading();
            
            try {
                const newNote = {
                    id: generateId(),
                    content: content,
                    authorId: currentUser.id,
                    authorName: currentUser.displayName,
                    createdAt: new Date().toISOString()
                };
                
                if (!currentRoom.notes) {
                    currentRoom.notes = [];
                }
                
                currentRoom.notes.push(newNote);
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                document.getElementById('addNoteModal').style.display = 'none';
                loadNotes();
                showAlert('Note added successfully', 'success');
                
            } catch (error) {
                showAlert('Error saving note: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;
            
            showLoading();
            
            try {
                currentRoom.notes = currentRoom.notes.filter(n => n.id !== noteId);
                await saveRoom(currentRoom);
                localStorage.setItem('ourspace_current_room', JSON.stringify(currentRoom));
                
                loadNotes();
                showAlert('Note deleted successfully', 'success');
            } catch (error) {
                showAlert('Error deleting note: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // GitHub Settings Management
        function loadGitHubSettings() {
            const token = localStorage.getItem('ourspace_github_token');
            const repo = localStorage.getItem('ourspace_github_repo');
            
            if (token) {
                githubToken = token;
                document.getElementById('githubToken').value = token;
            }
            
            if (repo) {
                githubRepo = repo;
                document.getElementById('githubRepo').value = repo;
            }
        }

        function saveGitHubSettings() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            
            if (token) {
                githubToken = token;
                localStorage.setItem('ourspace_github_token', token);
            }
            
            if (repo) {
                githubRepo = repo;
                localStorage.setItem('ourspace_github_repo', repo);
            }
            
            showAlert('GitHub settings saved successfully', 'success');
        }

        function useDefaultStorage() {
            githubToken = null;
            githubRepo = null;
            localStorage.removeItem('ourspace_github_token');
            localStorage.removeItem('ourspace_github_repo');
            document.getElementById('githubToken').value = '';
            document.getElementById('githubRepo').value = '';
            
            showAlert('Using default storage settings', 'success');
        }

        async function migrateToCustomRepo() {
            // This would copy all data from the default repo to the user's repo
            showAlert('This feature would copy all your data to your own repository. Implementation would require additional GitHub API calls.', 'info');
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
            
            showLoading();
            
            try {
                // Remove user from all rooms
                const allRooms = await getAllRooms();
                for (const room of allRooms) {
                    if (room.members.find(m => m.userId === currentUser.id)) {
                        room.members = room.members.filter(m => m.userId !== currentUser.id);
                        
                        // If user was admin, transfer admin rights
                        if (room.adminId === currentUser.id && room.members.length > 0) {
                            const newAdmin = room.members.reduce((oldest, member) => {
                                return new Date(member.joinedAt) < new Date(oldest.joinedAt) ? member : oldest;
                            });
                            
                            newAdmin.role = 'admin';
                            room.adminId = newAdmin.userId;
                            room.adminEmail = newAdmin.email;
                        }
                        
                        await saveRoom(room);
                    }
                }
                
                // Remove user from users list
                const users = await githubReadFile('users.json');
                const updatedUsers = users.filter(u => u.id !== currentUser.id);
                await githubWriteFile('users.json', updatedUsers);
                
                // Logout
                logout();
                showAlert('Account deleted successfully', 'success');
                
            } catch (error) {
                showAlert('Error deleting account: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteRoom(roomId) {
            const allRooms = await getAllRooms();
            const updatedRooms = allRooms.filter(r => r.id !== roomId);
            
            // We need to update all room files
            const master = await githubReadFile('rooms_master.json') || { files: ['rooms_data_1.json'] };
            
            for (const file of master.files) {
                const rooms = await githubReadFile(file) || [];
                const filteredRooms = rooms.filter(r => r.id !== roomId);
                await githubWriteFile(file, filteredRooms);
            }
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function generateUserId() {
            return 'user_' + generateId();
        }

        function generateRoomId() {
            return 'room_' + generateId();
        }

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        async function hashPassword(password) {
            // Simple hash for demo - use proper bcrypt in production
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'ourspace_salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // This function would be implemented to get the token from AppWrite secrets
        async function getSecretToken() {
            // In a real implementation, this would fetch the token from your backend
            // or from AppWrite secrets. For now, we'll return a dummy value.
            return "your_github_token_here";
        }
    </script>
</body>
</html>
